rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Regras para a coleção de utilizadores ──────────────────────────────
    match /users/{userId} {
      // Um utilizador só pode ler/escrever o seu próprio documento
      allow get: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      // Não permitir delete de utilizadores pela app
      allow delete: if false;
    }

    // ─── Regras para a coleção de favoritos ─────────────────────────────────
    match /favorites/{favoriteId} {
      // Leitura (get individual + list/query).
      // Para queries, o Firestore valida que todos os docs da query passam esta regra.
      // Como a query usa where("userId","==", uid) e a regra verifica o mesmo campo,
      // o Firestore aceita a query quando uid == request.auth.uid.
      allow read: if request.auth != null &&
                     resource.data.userId == request.auth.uid;

      // Criar: o userId no documento tem de corresponder ao uid autenticado
      allow create: if request.auth != null &&
                       request.resource.data.userId == request.auth.uid;

      // Atualizar/Eliminar: o documento pertence ao utilizador autenticado
      allow update: if request.auth != null &&
                       resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null &&
                       resource.data.userId == request.auth.uid;
    }

    // ─── Negar todo o resto por defeito ─────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
